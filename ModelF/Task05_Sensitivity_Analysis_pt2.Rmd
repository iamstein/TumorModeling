---
title: "Task04_Sensitivity_Analysis"
author: "Sameed Ahmed"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
# output:
#   html_document:
#     toc: true
#     toc_float: true
#     code_folding: hide
---

# Preliminary stuff

```{r, warning=FALSE}
# Need this to get rxode working. I don't know why I keep having to run this.
Sys.setenv(PATH = paste(Sys.getenv("PATH"), "C:/RBuildTools/3.4/bin/",
            "C:/RBuildTools/3.4/mingw_64/bin", sep = ";"))
Sys.setenv(BINPREF = "C:/RBuildTools/3.4/mingw_64/bin/")

# To be called at the top of every Rmd file. Initialization code and some useful constants.
suppressMessages(source("ams_initialize_script.R"))
```

# Function to compute sensitivity analysis

```{r}
# This function does the sensitivity analysis on the user inputted parameter and compares the theoretical result to the simulated result.

# Input: 
# model - model system of ODE's solved with RxODE. In this project, it is 'ivsc_4cmtct_shedct'.
# param.as.double - read parameters from Excel file. read.param.file("file directory").
# dose.nmol.range - range of dose in nmol. We will always do SA on dose. <- Is this true?
# tmax - time of treatment in days
# tau - frequency of administering dose in days
# compartment - compartment where drug is administered
# param.to.change - parameter on which to do SA. This must be a string.
# param.to.change.range - range of parameter on which to do SA. This must be a vector of odd length.

# Output:
# Plot of theoretical and simulated AFIRT vs fold change in parameter
# Data frame of AFIRT vs parameter value

compare.thy.sim = function(model = model, 
                           param.as.double = param.as.double,
                           dose.nmol.range = dose.nmol.range,
                           tmax = tmax,
                           tau = tau,
                           compartment = compartment,
                           param.to.change = param.to.change,
                           param.to.change.range = param.to.change.range) {

    
  # Initialize ------------------------------------------------------------------------------------------
  ##### This is currently passed as function parameter. The next line may be unnecessary.
  # Set range for parameters of interest in SA.
  # param.to.change.range = lseq(param.nominal$param.to.change*.1, param.nominal$param.to.change*10, 7)
  
  # Evaluate model --------------------------------------------------------------------------------------
  #### Simulation.
  # Put all simulations for different dose into one data frame.
  df_sim = data.frame()
  # Iterate through values in range. 
  dose.nmol = 10*scale.mpk2nmol
  for (param.iter in param.to.change.range){
    param.as.double[param.to.change] = param.iter
    row = lumped.parameters.simulation(model, param.as.double, dose.nmol, tmax, tau, compartment)
    df_sim = rbind(df_sim, row)
  }
  
  df_sim = df_sim %>% mutate(param.to.change = param.to.change.range,
                             fold.change = param.to.change.range/median(param.to.change.range))
  
  ### Theoretical
  # Put all theoretical calculations for different dose into one data frame.
  df_thy = data.frame()
  # Iterate through values in range.
  for (param.iter in param.to.change.range){
    param.as.double[param.to.change] = param.iter
    row = lumped.parameters.theory(param.as.double, dose.nmol, tau)
    df_thy = rbind(df_thy, row)
  }
  
  df_thy = df_thy %>% mutate(param.to.change = param.to.change.range,
                             fold.change = param.to.change.range/median(param.to.change.range))
  
  # Arrange theory and simulation in single data frame.
  df_compare = bind_rows(df_thy,df_sim)
  param.to.change.test = param.to.change
  df_compare = df_compare %>%
    mutate(param = param.to.change.test) %>%
    arrange(param.to.change,type) %>%
    mutate_if(is.numeric,signif,2)
  # print(df_compare)
  
  # Plot results ---------------------------------------------------------------------
  if (FALSE) {
  # Arrange data in a way suitable for plotting.
  # Param  = data.frame(Param = param.to.change.range/median(param.to.change.range))
  Data  = data.frame(Param = param.to.change.range/median(param.to.change.range),
                     AFIRT.sim  = df_sim$AFIRT.sim,
                     AFIRT.Kssd = df_thy$AFIRT.Kssd,
                     AFIRT.Kss  = df_thy$AFIRT.Kss,
                     AFIRT.Kd   = df_thy$AFIRT.Kd)
  # Data  = data.frame(Param, AFIRT)
  # names = names(Data)
  # Data  = Data %>% gather(key, AFIRT.value, -c(get(names[1])))
  print(Data)

  # Plot all AFIRT's on same axes.
  g = ggplot(Data, aes(Param, AFIRT.value, color=key)) +
      scale.x.log10() +
      scale.y.log10() +
      geom_line() +
      geom_point() + 
      labs(x = param.to.change)
  print(g)
  }
  return(df_compare)
}
```

```{r}
# Trying to separate plotting function from building dataframe
createPlot = function(compare, range){
  df = split(compare, compare$type)
  # Arrange data in a way suitable for plotting.
  Data  = data.frame(Param = range/median(range),
                     AFIRT.sim  = df$simulation$AFIRT.sim,
                     AFIRT.Kssd = df$theory$AFIRT.Kssd,
                     AFIRT.Kss  = df$theory$AFIRT.Kss,
                     AFIRT.Kd   = df$theory$AFIRT.Kd)
  Data  = Data %>% gather(key, AFIRT.value, -c(get(names[1])))

  # Plot all AFIRT's on same axes.
  g = ggplot(Data, aes(Param, AFIRT.value, color=key)) +
      scale.x.log10() +
      scale.y.log10() +
      geom_line() +
      geom_point() + 
      facet_grid(. ~ param)
      # theme(strip.text.x = element_blank())
      #labs(x = df$theory$param)
  print(g)
}
```

# Example of calling this function
```{r}
# Load model.
model = ivsc_4cmtct_shedct()
# Load parameters.
param.as.double     =  read.param.file("../data/ModelF_Atezolizumab_Params.xlsx")
df_param =  as.data.frame(t(param.as.double))

# Set range for parameters of interest in SA.
# dose.nmol.range = lseq(.1,10,7)*scale.mpk2nmol
ksynM3.range    = lseq(df_param$ksynM3*.1,   df_param$ksynM3*10,   7)
k13D.range      = lseq(df_param$k13D*.1,     df_param$k13D*10,     7)

# 0 so excluded
# kshedDM3.range  = lseq(df_param$kshedDM3*.1, df_param$kshedDM3*10, 7)
# k13DM.range     = lseq(df_param$k13DM*.1,    df_param$k13DM*10,    7)
# k31DM.range     = lseq(df_param$k31DM*.1,    df_param$k31DM*10,    7)

# Dose time, frequency, and compartment
tmax = 26*7 #days
tau  = 21   #days
compartment = 2

df_compare_1 = compare.thy.sim(model = model,
                             param.as.double = param.as.double,
                             dose.nmol.range = dose.nmol.range,
                             tmax = tmax,
                             tau  = tau,
                             compartment = compartment,
                             param.to.change = 'ksynM3',
                             param.to.change.range = ksynM3.range)
fold.change = ksynM3.range/median(ksynM3.range)
# createPlot(df_compare_1, fold.change)

df_compare_2 = compare.thy.sim(model = model,
                             param.as.double = param.as.double,
                             dose.nmol.range = dose.nmol.range,
                             tmax = tmax,
                             tau  = tau,
                             compartment = compartment,
                             param.to.change = 'k13D',
                             param.to.change.range = k13D.range)

joined = rbind(df_compare_1, df_compare_2)
joined = joined[c("fold.change","AFIRT.Kssd", "AFIRT.Kss", "AFIRT.Kd", "AFIRT.sim", "param")]
joined = joined %>% gather(key, AFIRT.value, -param, -fold.change) %>% 
                    filter(!is.na(AFIRT.value))

g = ggplot(joined, aes(fold.change, AFIRT.value, color=key)) +
      scale.x.log10() +
      scale.y.log10() +
      geom_line() +
      geom_point() + 
      facet_grid(. ~ param)
      # theme(strip.text.x = element_blank())
      #labs(x = df$theory$param)
print(g)
```